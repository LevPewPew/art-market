<% provide :head_tags do %>
  <meta name='turbolinks-visit-control' content='reload'>
  <script>
  document.addEventListener("DOMContentLoaded", function(){
    initMap(<%= -37.8825299 %>, <%= 144.7868242 %>)
  });
  </script>
<% end %>

<%= 'TESTING ADDRESS' %>
<%= @listing.user.user_detail.address %>
<%# Geocoder.search("Paris").first.coordinates %>
<%# Geocoder.search("2 Weber Court, Altona Meadows Melbourne VIC 3028").first.coordinates %>
<%= 'TESTING ADDRESS' %>

<p id="notice"><%= notice %></p>

<p>
  <strong>Title:</strong>
  <%= @listing.title %>
</p>

<p>
  <strong>Artist:</strong>
  <%= @listing.artist %>
</p>

<p>
  <strong>User:</strong>
  <%= @listing.user.user_detail.name %>
</p>

<p>
  <strong>Price:</strong>
  <%= @listing.price %>
</p>

<%# TODO add listing styles to display %>

<p>
  <strong>Description:</strong>
  <%= @listing.description %>
</p>

<p>
  <strong>Image:</strong>
  <br>
  <%= image_tag @listing.picture, width: "300px" if @listing.picture.attached? %>
</p>

<hr>

<p>
  <strong>Discussion:</strong>
  <br>
  <% @listing.comments.each do |comment| %>
    <div>
      <div>
        <em><%= comment.user.user_detail.name %></em>
        <em><%= comment.created_at %></em>
      </div>
      <%= comment.body %>
      <% if !current_user.nil? %>
        <% if current_user.id == comment.user_id || current_user.user_detail.super_user || current_user.user_detail.comms_mngr %>
          <%= link_to 'Edit', edit_listing_comment_path(listing_id: @listing.id, id: comment.id) %>
          <%= link_to 'Destroy', [comment.listing, comment], method: :delete, data: { confirm: 'Are you sure?' } %>
        <% end %>
      <% end %>
    </div>
  <% end %>
</p>

<strong>Discuss this Piece</strong>
<% if current_user.nil? %>
  <br>
  <%= link_to "Sign In to Comment!", new_user_session_path %>
<% else %>
  <%= render 'comments/form' %>
<% end %>

<hr>

<% if !current_user.nil? %>
  <% if !@listing.purchase && @listing.user.id != current_user.id %>
    <button data-stripe="payment">Purchase</button>

    <%# this script is needed for stripe to work, i don't know exactly how it works, got it from the docs %>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
      document
        .querySelector("[data-stripe='payment']")
        .addEventListener("click", () => {
          const stripe = Stripe(
            "<%= Rails.application.credentials.dig(:stripe, :public_key) %>"
          );

          stripe.redirectToCheckout({
            sessionId: "<%= @session_id %>"
          });
        });
    </script>
  <% end %>
<% end %>

<br>
<br>

<div class="location-container">
  <div class="location-marker">
    <svg width="200" height="200">
      <circle cx="100" cy="100" r="95" style="fill:rgba(186,59,70,0.2);stroke-width:3;stroke:rgba(186,59,70,1)" />
    </svg>
  </div>
  <div id="map"></div>
</div>
<script>
  function initMap(lat, lng) {
    var myCoords = new google.maps.LatLng(lat, lng);
    var mapOptions = {
      center: myCoords,
      zoom: 17
    };
    var map = new google.maps.Map(document.getElementById('map'), mapOptions);


  }
</script>

<%= link_to 'Back', listings_path %>
